<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŸ”æ€§ 37% æ³•åˆ™ï¼šå®¹å¿åŒºé—´æ¨¡æ‹Ÿ</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f0f4f8; color: #333; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; max-width: 650px; width: 100%; }
        
        /* é¡¶éƒ¨è®¾ç½®æ  */
        .settings-bar { display: flex; align-items: center; justify-content: center; margin-bottom: 20px; gap: 10px; background: #f8f9fa; padding: 10px; border-radius: 8px; }
        .settings-bar label { font-size: 0.9em; color: #555; font-weight: bold; }
        .settings-bar input { width: 60px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; text-align: center; font-size: 1em; }
        .btn-apply { padding: 6px 12px; font-size: 0.9em; background-color: #34495e; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn-apply:hover { background-color: #2c3e50; }

        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-bar { display: flex; height: 10px; width: 100%; margin-bottom: 20px; border-radius: 5px; overflow: hidden; }
        .progress-segment { height: 100%; transition: opacity 0.3s; }
        .seg-explore { background-color: #bdc3c7; flex: 0.37; } 
        .seg-exploit { background-color: #3498db; flex: 0.63; } 
        .phase-label { display: flex; justify-content: space-between; font-size: 0.8em; color: #7f8c8d; margin-top: -15px; margin-bottom: 15px; }

        .game-area { margin: 20px 0; height: 220px; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #eef2f5; border-radius: 12px; position: relative; overflow: hidden; transition: background 0.3s; }
        .game-area.explore-phase { border: 2px dashed #95a5a6; }
        .game-area.exploit-phase { border: 2px solid #3498db; }
        
        .phase-indicator { position: absolute; top: 10px; right: 10px; font-size: 0.8em; padding: 4px 8px; border-radius: 4px; font-weight: bold; }
        .tag-explore { background: #bdc3c7; color: #fff; }
        .tag-exploit { background: #3498db; color: #fff; }

        .diamond { font-size: 60px; font-weight: bold; color: #3498db; transition: transform 0.3s; }
        
        /* æ™ºèƒ½æ•°æ®é¢æ¿ */
        .smart-panel { display: flex; justify-content: space-around; width: 90%; background: #fff; padding: 8px; border-radius: 8px; margin-top: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .smart-item { font-size: 0.8em; color: #555; display: flex; flex-direction column; }
        .smart-val { font-size: 1.1em; font-weight: bold; color: #2c3e50; }
        .smart-tol { color: #e67e22; }

        .controls { display: flex; gap: 15px; justify-content: center; margin-bottom: 20px; margin-top: 20px; }
        button { padding: 12px 24px; font-size: 16px; cursor: pointer; border: none; border-radius: 8px; font-weight: bold; transition: 0.2s; }
        .btn-reject { background-color: #e74c3c; color: white; }
        .btn-reject:hover { background-color: #c0392b; }
        .btn-accept { background-color: #2ecc71; color: white; }
        .btn-accept:hover { background-color: #27ae60; }
        .btn-reset { background-color: #34495e; color: white; }
        
        .info { font-size: 0.9em; color: #7f8c8d; margin-bottom: 10px; display: flex; justify-content: space-between; padding: 0 20px; }
        
        .result-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); display: flex; flex-direction: column; justify-content: flex-start; align-items: center; display: none; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .result-text { font-size: 1.3em; margin-bottom: 5px; font-weight: bold; margin-top: 10px; }
        
        /* å¯¹æ¯”åˆ†æå¡ç‰‡ */
        .comparison-box { display: flex; gap: 10px; width: 100%; margin-top: 15px; text-align: left; }
        .strat-card { flex: 1; background: #f8f9fa; padding: 10px; border-radius: 8px; font-size: 0.85em; border-left: 3px solid #ccc; }
        .strat-strict { border-color: #95a5a6; }
        .strat-flex { border-color: #e67e22; background: #fffbf0; }
        
        .success-badge { color: #27ae60; font-weight: bold; }
        .fail-badge { color: #e74c3c; font-weight: bold; }
        .ok-badge { color: #f39c12; font-weight: bold; }
        .forced-badge { color: #c0392b; font-weight: bold; border: 1px solid #c0392b; padding: 0 4px; border-radius: 4px; font-size: 0.9em;}

        h2 { color: #2c3e50; margin-top: 0; }
    </style>
</head>
<body>

<div class="container">
    <h2>é’»çŸ³çŒäººï¼šæŸ”æ€§ 37% ç­–ç•¥</h2>
    <p style="color: #666; font-size: 0.9em;">æ–°æ€è·¯ï¼šåŸºäºè§‚å¯ŸæœŸæ³¢åŠ¨çš„â€œå®¹å¿åŒºé—´â€ï¼Œèƒ½å¦æ‹¯æ•‘åƒµåŒ–çš„ç®—æ³•ï¼Ÿ</p>
    
    <div class="settings-bar">
        <label for="totalGemsInput">é’»çŸ³æ€»æ•° (N):</label>
        <input type="number" id="totalGemsInput" value="15" min="5" max="100">
        <button class="btn-apply" onclick="initGame()">é‡ç½® / å¼€å§‹</button>
    </div>

    <div class="progress-bar">
        <div class="progress-segment seg-explore"></div>
        <div class="progress-segment seg-exploit"></div>
    </div>
    <div class="phase-label">
        <span>è§‚å¯ŸæœŸ (å»ºç«‹åŸºå‡†)</span>
        <span>è¡ŒåŠ¨æœŸ (æ™ºèƒ½å†³ç­–)</span>
    </div>

    <div class="info">
        <span>ç¬¬ <b id="currentStep">1</b> / <span id="totalStepDisplay">15</span> é¢—</span>
        <span>å…¨åœºæœ€é«˜(ä¸Šå¸è§†è§’): <b id="godViewMax" style="color:transparent; text-shadow: 0 0 5px #ccc;">?</b></span>
    </div>

    <div class="game-area" id="gameArea">
        <div id="phaseTag" class="phase-indicator tag-explore">è§‚å¯ŸæœŸ</div>
        <div class="diamond" id="diamondValue">?</div>
        
        <!-- æ™ºèƒ½æ•°æ®çœ‹æ¿ -->
        <div class="smart-panel" id="smartPanel" style="opacity: 0.5;">
            <div class="smart-item">
                <span>æœ€é«˜åŸºå‡†</span>
                <span class="smart-val" id="benchmarkVal">-</span>
            </div>
            <div class="smart-item">
                <span>æ•°æ®æ³¢åŠ¨(StdDev)</span>
                <span class="smart-val" id="stdDevVal">-</span>
            </div>
            <div class="smart-item">
                <span>æŸ”æ€§æ»¡æ„çº¿</span>
                <span class="smart-val smart-tol" id="toleranceVal">-</span>
            </div>
        </div>

        <div class="result-overlay" id="resultOverlay">
            <div class="result-text" id="resultMessage"></div>
            <div style="font-size: 0.9em; color: #555;" id="resultDetail"></div>
            
            <!-- ç­–ç•¥å¯¹æ¯” -->
            <div style="width:100%; margin-top:15px; font-weight:bold; font-size:0.9em; text-align:left;">ğŸ¤– AI ç­–ç•¥å¤ç›˜ï¼š</div>
            <div class="comparison-box">
                <div class="strat-card strat-strict" id="strictAnalysis"></div>
                <div class="strat-card strat-flex" id="flexAnalysis"></div>
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="btn-reject" id="btnReject" onclick="nextDiamond()">ä¸‹ä¸€ä¸ª</button>
        <button class="btn-accept" id="btnAccept" onclick="acceptDiamond()">æˆäº¤</button>
        <button class="btn-reset" id="btnReset" onclick="initGame()" style="display:none">å†è¯•ä¸€æ¬¡</button>
    </div>
</div>

<script>
    let TOTAL_GEMS = 15;
    let EXPLORE_COUNT = 5; 
    
    let gems = [];
    let currentIndex = 0;
    
    // ç­–ç•¥å˜é‡
    let benchmarkMax = 0; 
    let exploreGems = [];
    let stdDev = 0;
    let toleranceThreshold = 0; // æŸ”æ€§é˜ˆå€¼
    
    let trueMaxVal = 0;
    let isGameOver = false;

    // UI Elements
    const elTotalInput = document.getElementById('totalGemsInput');
    const elTotalDisplay = document.getElementById('totalStepDisplay');
    const elDiamond = document.getElementById('diamondValue');
    const elStep = document.getElementById('currentStep');
    const elBenchmark = document.getElementById('benchmarkVal');
    const elStdDev = document.getElementById('stdDevVal');
    const elTolerance = document.getElementById('toleranceVal');
    const elSmartPanel = document.getElementById('smartPanel');
    const elGameArea = document.getElementById('gameArea');
    const elPhaseTag = document.getElementById('phaseTag');
    const elOverlay = document.getElementById('resultOverlay');
    const elMsg = document.getElementById('resultMessage');
    const elDetail = document.getElementById('resultDetail');
    const elStrictAnalysis = document.getElementById('strictAnalysis');
    const elFlexAnalysis = document.getElementById('flexAnalysis');
    
    const btnReject = document.getElementById('btnReject');
    const btnAccept = document.getElementById('btnAccept');
    const btnReset = document.getElementById('btnReset');

    function initGame() {
        // è¯»å–ç”¨æˆ·è®¾ç½®
        let inputVal = parseInt(elTotalInput.value);
        if(isNaN(inputVal) || inputVal < 5) inputVal = 5;
        if(inputVal > 100) inputVal = 100;
        TOTAL_GEMS = inputVal;
        elTotalInput.value = TOTAL_GEMS; // æ ¡æ­£æ˜¾ç¤º
        elTotalDisplay.innerText = TOTAL_GEMS;

        // è®¡ç®—è§‚å¯ŸæœŸ (N * 0.37)
        EXPLORE_COUNT = Math.floor(TOTAL_GEMS * 0.37);
        if (EXPLORE_COUNT < 1) EXPLORE_COUNT = 1;

        // ç”Ÿæˆéšæœºé’»çŸ³ (1-100)
        let pool = Array.from({length: 100}, (_, i) => i + 1);
        gems = [];
        for(let i=0; i<TOTAL_GEMS; i++) {
            const randIndex = Math.floor(Math.random() * pool.length);
            gems.push(pool[randIndex]);
            // ä¸ºäº†ä¿è¯é•¿åºåˆ—ä¹Ÿèƒ½éšæœºå–ï¼Œæˆ‘ä»¬å…è®¸æ”¾å›æˆ–è€…ä¸æ”¾å›ï¼Ÿ
            // åŸé€»è¾‘æ˜¯ä¸æ”¾å› (ä¸é‡å¤)ï¼Œä½†å¦‚æœ TOTAL_GEMS > 100 ä¼šæœ‰é—®é¢˜ã€‚
            // ç®€å•èµ·è§ï¼Œå¦‚æœ N > 50ï¼Œæˆ‘ä»¬å…è®¸é‡å¤ï¼Œæˆ–è€…åªæ˜¯ç”Ÿæˆéšæœºæ•°ã€‚
            // è¿™é‡Œä¸ºäº†ç®€å•ï¼Œç›´æ¥ç”Ÿæˆéšæœºæ•°ï¼Œä¸ä¾èµ– pool spliceï¼Œé˜²æ­¢è€—å°½ã€‚
            // ä½†ä¸ºäº†ä¿æŒæ¸¸æˆæ€§ï¼ˆä¸é‡å¤æ›´æ¸…æ™°ï¼‰ï¼Œæˆ‘ä»¬é‡æ–°ç”Ÿæˆ pool é€»è¾‘
        }
        // é‡å†™ç”Ÿæˆé€»è¾‘ï¼Œæ”¯æŒ N > 100 çš„æƒ…å†µ (å•çº¯éšæœºæ•°)
        gems = Array.from({length: TOTAL_GEMS}, () => Math.floor(Math.random() * 100) + 1);
        
        trueMaxVal = Math.max(...gems);
        
        // Reset Variables
        currentIndex = 0;
        benchmarkMax = 0;
        exploreGems = [];
        stdDev = 0;
        toleranceThreshold = 0;
        isGameOver = false;

        updateUI();
        elOverlay.style.display = 'none';
        btnReject.style.display = 'inline-block';
        btnAccept.style.display = 'inline-block';
        btnReset.style.display = 'none';
        
        elBenchmark.innerText = "-";
        elStdDev.innerText = "-";
        elTolerance.innerText = "-";
        elSmartPanel.style.opacity = "0.5";
        
        // æ‚„æ‚„æ˜¾ç¤ºçœŸå€¼æ–¹ä¾¿æµ‹è¯•
        document.getElementById('godViewMax').innerText = trueMaxVal;
    }

    function calculateStats(arr) {
        if (arr.length === 0) return { mean: 0, std: 0 };
        const mean = arr.reduce((a, b) => a + b) / arr.length;
        const variance = arr.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / arr.length;
        return { mean, std: Math.sqrt(variance) };
    }

    function updateUI() {
        if (currentIndex >= TOTAL_GEMS) {
            endGame(null); 
            return;
        }

        const isExplorePhase = currentIndex < EXPLORE_COUNT;
        
        if (isExplorePhase) {
            elGameArea.className = "game-area explore-phase";
            elPhaseTag.className = "phase-indicator tag-explore";
            elPhaseTag.innerText = `è§‚å¯ŸæœŸ (${currentIndex+1}/${EXPLORE_COUNT})`;
            btnAccept.disabled = true;
            btnAccept.style.opacity = "0.5";
            btnAccept.innerText = "è®°å½•ä¸­...";
        } else {
            elGameArea.className = "game-area exploit-phase";
            elPhaseTag.className = "phase-indicator tag-exploit";
            elPhaseTag.innerText = "è¡ŒåŠ¨æœŸ (è¶…è¶Šå³ä¹°)";
            btnAccept.disabled = false;
            btnAccept.style.opacity = "1";
            btnAccept.innerText = "æˆäº¤ï¼";
            elSmartPanel.style.opacity = "1";
        }

        // Animation
        elDiamond.style.transform = "scale(0.5)";
        elDiamond.style.opacity = "0";
        setTimeout(() => {
            const val = gems[currentIndex];
            elDiamond.innerText = val;
            elDiamond.style.transform = "scale(1)";
            elDiamond.style.opacity = "1";
            
            // æç¤ºé€»è¾‘
            if (!isExplorePhase && val >= toleranceThreshold) {
                if (val > benchmarkMax) {
                    elDiamond.style.color = "#27ae60"; 
                    elPhaseTag.innerText = "è¶…å¼ºï¼(è¶…è¶ŠåŸºå‡†)";
                    elPhaseTag.style.background = "#27ae60";
                } else {
                    elDiamond.style.color = "#e67e22"; 
                    elPhaseTag.innerText = "ä¸é”™ï¼(å®¹å¿åŒºé—´)";
                    elPhaseTag.style.background = "#e67e22";
                }
            } else if (!isExplorePhase) {
                 elDiamond.style.color = "#3498db"; 
                 elPhaseTag.style.background = "#3498db";
            } else {
                 elDiamond.style.color = "#95a5a6"; 
                 elPhaseTag.style.background = "#bdc3c7";
            }

        }, 150);

        elStep.innerText = currentIndex + 1;
    }

    function nextDiamond() {
        if (isGameOver) return;
        
        // è§‚å¯ŸæœŸé€»è¾‘ï¼šè®°å½•æ•°æ®
        if (currentIndex < EXPLORE_COUNT) {
            exploreGems.push(gems[currentIndex]);
            if (gems[currentIndex] > benchmarkMax) {
                benchmarkMax = gems[currentIndex];
            }
            
            const stats = calculateStats(exploreGems);
            stdDev = stats.std;
            // æŸ”æ€§é˜ˆå€¼å…¬å¼
            toleranceThreshold = Math.floor(benchmarkMax - (stdDev * 0.5));
            
            elBenchmark.innerText = benchmarkMax;
            elStdDev.innerText = stdDev.toFixed(1);
            elTolerance.innerText = toleranceThreshold;
        }

        currentIndex++;
        if (currentIndex >= TOTAL_GEMS) {
            endGame(gems[TOTAL_GEMS - 1]);
        } else {
            updateUI();
        }
    }

    function acceptDiamond() {
        if (isGameOver) return;
        endGame(gems[currentIndex]);
    }

    function endGame(chosenVal) {
        isGameOver = true;
        elOverlay.style.display = 'flex';
        btnReject.style.display = 'none';
        btnAccept.style.display = 'none';
        btnReset.style.display = 'inline-block';

        // 1. ç©å®¶ç»“æœ
        if (chosenVal === trueMaxVal) {
            elMsg.innerHTML = `<span class="success">ğŸ‰ å®Œç¾ï¼</span>`;
            elDetail.innerText = `ä½ æ‹¿åˆ°äº† ${chosenVal} (å…¨åœºæœ€é«˜)ã€‚`;
        } else if (chosenVal >= trueMaxVal * 0.9) {
             elMsg.innerHTML = `<span class="ok-badge">ğŸ‘Œ å¾ˆæ£’çš„é€‰æ‹©ï¼</span>`;
             elDetail.innerText = `ä½ æ‹¿åˆ°äº† ${chosenVal}ï¼Œæœ€é«˜æ˜¯ ${trueMaxVal}ã€‚`;
        } else {
            elMsg.innerHTML = `<span class="fail">ğŸ’” æœ‰ç‚¹é—æ†¾</span>`;
            elDetail.innerText = `ä½ æ‹¿åˆ°äº† ${chosenVal}ï¼Œä½†æœ€é«˜æ˜¯ ${trueMaxVal}ã€‚`;
        }

        // 2. åŒç­–ç•¥æ¨¡æ‹Ÿ
        // A. ä¸¥æ ¼ 37% ç­–ç•¥ (Benchmark Strict)
        let strictChoice = -1;
        let strictResult = "";
        let strictForced = false;
        
        // æ¨¡æ‹Ÿè§‚å¯ŸæœŸ
        let simBenchmark = 0;
        for(let i=0; i<EXPLORE_COUNT; i++) if(gems[i] > simBenchmark) simBenchmark = gems[i];
        
        // æ¨¡æ‹Ÿè¡ŒåŠ¨æœŸ
        for(let i=EXPLORE_COUNT; i<TOTAL_GEMS; i++) {
            if(gems[i] > simBenchmark) {
                strictChoice = gems[i];
                break;
            }
        }
        // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œè¢«è¿«é€‰æœ€åä¸€ä¸ª
        if(strictChoice === -1) {
            strictChoice = gems[TOTAL_GEMS-1];
            strictForced = true;
        }

        // åˆ¤å®šä¸¥æ ¼ç­–ç•¥
        if (strictChoice === trueMaxVal) {
            strictResult = `<span class="success-badge">èµ¢</span> é€‰ä¸­æœ€ä¼˜ (${strictChoice})`;
        } else if (strictForced) {
            // è¿™é‡Œæ˜¯ç”¨æˆ·è¦æ±‚çš„ä¿®æ”¹ç‚¹ï¼šæ˜ç¡®æ˜¾ç¤ºå°¾éƒ¨ç»“æœ
            strictResult = `<span class="forced-badge">æƒ¨è´¥</span> åŸºå‡†å¤ªé«˜ï¼Œè¢«è¿«æ¥ç›˜æœ€åä¸€ä¸ª: <b>${strictChoice}</b>`;
        } else {
            strictResult = `<span class="fail-badge">è¾“</span> é€‰äº† ${strictChoice} (æœ€é«˜ ${trueMaxVal})`;
        }


        // B. æŸ”æ€§ç­–ç•¥ (Benchmark - k*StdDev)
        let flexChoice = -1;
        let flexResult = "";
        
        let simExploreArr = gems.slice(0, EXPLORE_COUNT);
        let simStats = calculateStats(simExploreArr);
        let simTol = simBenchmark - (simStats.std * 0.5); 

        for(let i=EXPLORE_COUNT; i<TOTAL_GEMS; i++) {
            if(gems[i] >= simTol) {
                flexChoice = gems[i];
                break;
            }
        }
        if(flexChoice === -1) flexChoice = gems[TOTAL_GEMS-1];

        if (flexChoice === trueMaxVal) flexResult = `<span class="success-badge">å®Œç¾</span> é€‰ä¸­æœ€ä¼˜ (${flexChoice})`;
        else if (flexChoice >= trueMaxVal * 0.9) flexResult = `<span class="ok-badge">æ»¡æ„</span> é€‰ä¸­æ¬¡ä¼˜ ${flexChoice}`;
        else flexResult = `<span class="fail-badge">ä¸€èˆ¬</span> é€‰äº† ${flexChoice}`;
        
        // ç‰¹æ®Šé«˜äº®
        let note = "";
        if (gems.indexOf(trueMaxVal) < EXPLORE_COUNT) {
            if (flexChoice >= trueMaxVal * 0.9) {
                note = "<br><strong>ğŸ”¥ é€†å¤©æ”¹å‘½ï¼</strong> æœ€ä¼˜åœ¨è§‚å¯ŸæœŸï¼Œä¸¥æ ¼AIå·²æ­»ï¼ŒæŸ”æ€§AIèƒœã€‚";
            }
        }

        elStrictAnalysis.innerHTML = `<strong>1. ä¸¥æ ¼ 37% ç­–ç•¥</strong><br>æ‹’ç»å‰ ${EXPLORE_COUNT} ä¸ªï¼ŒåŸºå‡† ${simBenchmark}<br>ç»“æœ: ${strictResult}`;
        elFlexAnalysis.innerHTML = `<strong>2. æŸ”æ€§ç­–ç•¥</strong><br>æ»¡æ„çº¿ > ${Math.floor(simTol)} (æ³¢åŠ¨:${simStats.std.toFixed(0)})<br>ç»“æœ: ${flexResult}${note}`;
    }

    initGame();
</script>

</body>
</html>